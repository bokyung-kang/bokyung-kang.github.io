<!doctype html><html lang=ko dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CloudFront와 Lambda@Edge를 이용해서 이미지 리사이징하기 | Bokyung's Note</title><meta name=keywords content="AWS,AWS CloudFront,AWS Lambda@Edge,Image Resizing,AWS S3"><meta name=description content="리사이징 된 이미지를 S3에 저장하지 않고 원본만 이용해서 리사이징 하는 방법은 없을까 고민하던차에 Lambda@Edge를 이용해서 이미지 리사이징 하는 방법을 적용해 보았습니다.
Lambda@Edge 동작 원리    Lambda@Edge는 CloudFront에 접근할 때 실행되는 Lambda의 확장판입니다. CloudFront 이벤트가 발생할 때 Lambda 함수를 실행할 수 있습니다. 이벤트는 4가지가 있습니다.
 Viewer Request : CloudFront가 뷰어로부터 요청을 받고 요청한 개체가 edge cache에 있는지 확인하기 전에 함수를 실행합니다. Origin Request : CloudFront가 오리진으로 요청을 전달할 때만 실행됩니다."><meta name=author content="bokyung"><link rel=canonical href=https://bokyung.dev/2021/05/14/lambda-edge-resize/><link href=/assets/css/stylesheet.min.16bd97329ca7f2188829d7cfd3e3c39c68f9f28afc3b6f43b1ac7302a00e6faf.css integrity="sha256-Fr2XMpyn8hiIKdfP0+PDnGj58or8O29DsaxzAqAOb68=" rel="preload stylesheet" as=style><link rel=icon href=https://bokyung.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bokyung.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://bokyung.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://bokyung.dev/apple-touch-icon.png><link rel=mask-icon href=https://bokyung.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><link rel=alternate hreflang=ko href=https://bokyung.dev/2021/05/14/lambda-edge-resize/><link rel=alternate hreflang=ja href=https://bokyung.dev/ja/2021/05/14/lambda-edge-resize/><meta property="og:title" content="CloudFront와 Lambda@Edge를 이용해서 이미지 리사이징하기"><meta property="og:description" content="리사이징 된 이미지를 S3에 저장하지 않고 원본만 이용해서 리사이징 하는 방법은 없을까 고민하던차에 Lambda@Edge를 이용해서 이미지 리사이징 하는 방법을 적용해 보았습니다.
Lambda@Edge 동작 원리    Lambda@Edge는 CloudFront에 접근할 때 실행되는 Lambda의 확장판입니다. CloudFront 이벤트가 발생할 때 Lambda 함수를 실행할 수 있습니다. 이벤트는 4가지가 있습니다.
 Viewer Request : CloudFront가 뷰어로부터 요청을 받고 요청한 개체가 edge cache에 있는지 확인하기 전에 함수를 실행합니다. Origin Request : CloudFront가 오리진으로 요청을 전달할 때만 실행됩니다."><meta property="og:type" content="article"><meta property="og:url" content="https://bokyung.dev/2021/05/14/lambda-edge-resize/"><meta property="article:published_time" content="2021-05-14T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-14T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="CloudFront와 Lambda@Edge를 이용해서 이미지 리사이징하기"><meta name=twitter:description content="리사이징 된 이미지를 S3에 저장하지 않고 원본만 이용해서 리사이징 하는 방법은 없을까 고민하던차에 Lambda@Edge를 이용해서 이미지 리사이징 하는 방법을 적용해 보았습니다.
Lambda@Edge 동작 원리    Lambda@Edge는 CloudFront에 접근할 때 실행되는 Lambda의 확장판입니다. CloudFront 이벤트가 발생할 때 Lambda 함수를 실행할 수 있습니다. 이벤트는 4가지가 있습니다.
 Viewer Request : CloudFront가 뷰어로부터 요청을 받고 요청한 개체가 edge cache에 있는지 확인하기 전에 함수를 실행합니다. Origin Request : CloudFront가 오리진으로 요청을 전달할 때만 실행됩니다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CloudFront와 Lambda@Edge를 이용해서 이미지 리사이징하기","name":"CloudFront와 Lambda@Edge를 이용해서 이미지 리사이징하기","description":"리사이징 된 이미지를 S3에 저장하지 않고 원본만 이용해서 리사이징 하는 방법은 없을까 고민하던차에 Lambda@Edge를 이용해서 이미지 리사이징 하는 방법을 적용해 보았습니다.\nLambda@Edge 동작 원리    Lambda@Edge는 CloudFront에 접근할 때 실행되는 Lambda의 확장판입니다. …","keywords":["AWS","AWS CloudFront","AWS Lambda@Edge","Image Resizing","AWS S3"],"articleBody":"리사이징 된 이미지를 S3에 저장하지 않고 원본만 이용해서 리사이징 하는 방법은 없을까 고민하던차에 Lambda@Edge를 이용해서 이미지 리사이징 하는 방법을 적용해 보았습니다.\nLambda@Edge 동작 원리    Lambda@Edge는 CloudFront에 접근할 때 실행되는 Lambda의 확장판입니다. CloudFront 이벤트가 발생할 때 Lambda 함수를 실행할 수 있습니다. 이벤트는 4가지가 있습니다.\n Viewer Request : CloudFront가 뷰어로부터 요청을 받고 요청한 개체가 edge cache에 있는지 확인하기 전에 함수를 실행합니다. Origin Request : CloudFront가 오리진으로 요청을 전달할 때만 실행됩니다. 요청한 개체가 edge cache에 있으면 함수가 실행되지 않습니다. Origin Response : CloudFront가 오리진으로부터 응답을 받은 후 응답에 개체를 cache하기 전에 함수를 실행합니다. Viewer Response : 요청한 개체를 뷰어에 반환하기 전에 기능이 실행됩니다. 이 함수는 개체가 edge cache에 이미 있는지 여부에 관계없이 실행됩니다.  Lambda@Edge 주의점  환경변수는 사용 불가 us-east-1 리전만 대응 이벤트 유형에 따라 다른 할당량    Entity Origin request and response event quotas Viewer request and response event quotas     Function memory size Same as Lambda quotas（128 MB to 10,240 MB） 128 MB   Function timeout 30 seconds 5 seconds   Size of a response 1 MB 40 KB   Maximum compressed size of a Lambda function and any included libraries 50 MB 1 MB      이미지 리사이징 구현 이미지 리사이징 처리 흐름 Origin Response이벤트 발생 시, Lambda@Edge함수 실행하는 방법을 이용했습니다.\n https://images.example.com/images/heic_image.heic?w=1500\u0026h=1500 에 접속 CloudFront에서 이미지를 요청했지만, cache되어있지 않은 상태. CloudFront가 S3오리진에 요청. S3오리진에 이미지가 존재하면, S3오리진에서 응답. Lambda 함수를 실행하여 이미지 리사이징. 리사이징 한 이미지를 CloudFront에 캐싱처리 요청. CloudFront는 캐싱 후, 브라우저에 리사이징 된 이미지를 표시.  CloudFront 설정 CloudFormation을 이용해서 구축했습니다. DistributionConfig 설정 중 일부를 살펴보겠습니다.  Lambda@Edge IAM Role 작성 Policy { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"VisualEditor0\", \"Effect\": \"Allow\", \"Action\": [ \"cloudfront:UpdateDistribution\", \"iam:CreateServiceLinkedRole\", \"s3:GetObject\", \"lambda:EnableReplication\", \"lambda:GetFunction\", \"logs:CreateLogGroup\", \"logs:CreateLogStream\", \"logs:PutLogEvents\" ], \"Resource\": \"*\" } ] } Trust Relationship Policy { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Service\": [ \"edgelambda.amazonaws.com\", \"lambda.amazonaws.com\" ] }, \"Action\": \"sts:AssumeRole\" } ] } Lambda 함수 작성 Sharp 리사이징용 패키지 설치 npm install --arch=x64 --platform=linux sharp AWS Lambda용 Sharp 설치 가이드 \nindex.js 작성  zip파일 업로드 index.js, node_modules을 zip파일로 압축하고 Code source  Upload from .zip file을 선택해서 파일을 업로드합니다. Runtime은 Node.js 14.x를 선택합니다.\n. ├── index.js ├── node_modules/ └── package.json Lambda@Edge 배포 Actions  Deploy to Lambda@Edge를 클릭하고 Lambda@Edge를 배포합니다.   리사이징 테스트 이미지 리사이징 heic파일을 jpeg로 변경하여 리사이징에 성공한 것을 확인할 수 있습니다.\ncurl -I 'https://images.example.com/images/heic_image.heic?w=1400\u0026h=1400' HTTP/2 200 content-type: image/jpeg content-length: 356013 date: Fri, 14 May 2021 01:50:28 GMT last-modified: Fri, 14 May 2021 01:37:54 GMT etag: \"9835f7aa1198532d0b538axxxxxxxxxx\" accept-ranges: bytes server: AmazonS3 x-cache: Miss from cloudfront via: 1.1 186a60433f9963bxxxxxxxxxxxxxx.cloudfront.net (CloudFront) x-amz-cf-pop: NRT20-C2 x-amz-cf-id: dihScCemgN8p_VVykjhmXZhkaRP1t7B_y0o_WZoJMK17hexhbHMU0g== 다시 접속하면 cache가 적용된 것을 확인할 수 있습니다.\ncurl -I 'https://images.example.com/images/heic_image.heic?w=1400\u0026h=1400' HTTP/2 200 content-type: image/jpeg content-length: 356013 date: Fri, 14 May 2021 01:50:28 GMT last-modified: Fri, 14 May 2021 01:37:54 GMT etag: \"9835f7aa1198532d0b538axxxxxxxxxx\" accept-ranges: bytes server: AmazonS3 x-cache: Hit from cloudfront via: 1.1 65866bb6c20ad09xxxxxxxxxxxxxxx.cloudfront.net (CloudFront) x-amz-cf-pop: NRT57-C2 x-amz-cf-id: C_g2WMkGFgKPtOX87AZBI6J66WDBDARs0pN23DBJSdMam6mUHntFEA== age: 3 Cloudfront SignedURL을 사용하는 경우  SignedURL을 발행합니다.  aws cloudfront sign \\  --url https://images.example.com/images/heic_image.heic?w=1400\u0026h=1400 \\  --key-pair-id K2XRXXXXXXXXXX \\  --private-key file:////private_key.pem \\  --date-less-than 2021-05-14T10:50:00+09:00 \\  --profile https://images.example.com/images/heic_image.heic?w=1400\u0026h=1400\u0026Expires=1620957000\u0026Signature=NLDdoaOrD0S8hyEIBzH6Q0otJagaRmUUtX3ZY0uuA0QIzc1e5D6z-ddQ~k0U1~4WQSiK-sDGplt-CPDiUTjz053yFlaDWzQohNybLLVRcUaKRXDgl~ahJPwjfstnKzzOl4g3Z628ZD-8UkLPnPaUx~Ibeo2Z55GFp8Ih0aNBZuPdd0al~4X5~lUGrsgZvRfg0QWis1X3VvShWPLL3nIphAFtJJu0~IfzyKNRZMQMTBvJcqL-ifdA2uj99VHGz-pec7r33y38TW5sirS6kQVJHe9WmAxjDQhTO42M04oSHwu~t6Mrxh3~DalyxEM0wcQ5yWOAKD9FA4~A7im-9tbBTg__\u0026Key-Pair-Id=K2XRXXXXXXXXXX  SignedURL에 접속 해 봅니다. heic파일을 jpeg로 변경하여 리사이징에 성공한 것을 확인할 수 있습니다.  curl -I 'https://images.example.com/images/heic_image.heic?w=1400\u0026h=1400\u0026Expires=1620957000\u0026Signature=NLDdoaOrD0S8hyEIBzH6Q0otJagaRmUUtX3ZY0uuA0QIzc1e5D6z-ddQ~k0U1~4WQSiK-sDGplt-CPDiUTjz053yFlaDWzQohNybLLVRcUaKRXDgl~ahJPwjfstnKzzOl4g3Z628ZD-8UkLPnPaUx~Ibeo2Z55GFp8Ih0aNBZuPdd0al~4X5~lUGrsgZvRfg0QWis1X3VvShWPLL3nIphAFtJJu0~IfzyKNRZMQMTBvJcqL-ifdA2uj99VHGz-pec7r33y38TW5sirS6kQVJHe9WmAxjDQhTO42M04oSHwu~t6Mrxh3~DalyxEM0wcQ5yWOAKD9FA4~A7im-9tbBTg__\u0026Key-Pair-Id=K2XRXXXXXXXXXX' HTTP/2 200 content-type: image/jpeg content-length: 356013 date: Fri, 14 May 2021 01:45:27 GMT last-modified: Fri, 14 May 2021 01:37:54 GMT etag: \"9835f7aa1198532d0b538axxxxxxxxxx\" accept-ranges: bytes server: AmazonS3 x-cache: Miss from cloudfront via: 1.1 25d5704e1dc4bae769b7dexxxxxxxxxx.cloudfront.net (CloudFront) x-amz-cf-pop: NRT57-C2 x-amz-cf-id: 1pJUhQFKbilToyrRCp4_IwkBec1ki3fh5G-Y0fltGoTeRA3WUsymPQ== 참고  https://sharp.pixelplumbing.com/install#aws-lambda  https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-requirements-limits.html  https://aws.amazon.com/blogs/networking-and-content-delivery/resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog/   ","wordCount":"540","inLanguage":"ko","datePublished":"2021-05-14T00:00:00Z","dateModified":"2021-05-14T00:00:00Z","author":{"@type":"Person","name":"bokyung"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bokyung.dev/2021/05/14/lambda-edge-resize/"},"publisher":{"@type":"Organization","name":"Bokyung's Note","logo":{"@type":"ImageObject","url":"https://bokyung.dev/favicon.ico"}}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-R7DJYPBNN5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-R7DJYPBNN5')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-KTQ8KCW')</script></script></head><body id=top><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KTQ8KCW" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://bokyung.dev/ accesskey=h title="Bokyung's Note (Alt + H)"><img src=/images/main_icon.jpg alt=logo aria-label=logo width=30px>Bokyung's Note</a>
<span class=logo-switches><ul class=lang-switch><li>|</li><li><a href=https://bokyung.dev/ja/ title=ja aria-label=ja>Ja</a></li></ul></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://bokyung.dev/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://bokyung.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://bokyung.dev/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=ad-box><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8342838924011258 data-ad-slot=6402405361 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><h1 class=post-title>CloudFront와 Lambda@Edge를 이용해서 이미지 리사이징하기</h1><div class=post-meta>2021-05-14&nbsp;·&nbsp;bokyung
&nbsp;|&nbsp;<ul class=i18n_list>Translations:<li><a href=https://bokyung.dev/ja/2021/05/14/lambda-edge-resize/>Ja</a></li></ul></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>목차</div></summary><div class=inner><ul><li><a href=#lambdaedge-%eb%8f%99%ec%9e%91-%ec%9b%90%eb%a6%ac aria-label="Lambda@Edge 동작 원리">Lambda@Edge 동작 원리</a></li><li><a href=#lambdaedge-%ec%a3%bc%ec%9d%98%ec%a0%90 aria-label="Lambda@Edge 주의점">Lambda@Edge 주의점</a></li><li><a href=#%ec%9d%b4%eb%af%b8%ec%a7%80-%eb%a6%ac%ec%82%ac%ec%9d%b4%ec%a7%95-%ea%b5%ac%ed%98%84 aria-label="이미지 리사이징 구현">이미지 리사이징 구현</a><ul><li><a href=#%ec%9d%b4%eb%af%b8%ec%a7%80-%eb%a6%ac%ec%82%ac%ec%9d%b4%ec%a7%95-%ec%b2%98%eb%a6%ac-%ed%9d%90%eb%a6%84 aria-label="이미지 리사이징 처리 흐름">이미지 리사이징 처리 흐름</a></li><li><a href=#cloudfront-%ec%84%a4%ec%a0%95 aria-label="CloudFront 설정">CloudFront 설정</a></li><li><a href=#lambdaedge-iam-role-%ec%9e%91%ec%84%b1 aria-label="Lambda@Edge IAM Role 작성">Lambda@Edge IAM Role 작성</a><ul><li><a href=#policy aria-label=Policy>Policy</a></li><li><a href=#trust-relationship-policy aria-label="Trust Relationship Policy">Trust Relationship Policy</a></li></ul></li><li><a href=#lambda-%ed%95%a8%ec%88%98-%ec%9e%91%ec%84%b1 aria-label="Lambda 함수 작성">Lambda 함수 작성</a><ul><li><a href=#indexjs-%ec%9e%91%ec%84%b1 aria-label="index.js 작성">index.js 작성</a></li><li><a href=#zip%ed%8c%8c%ec%9d%bc-%ec%97%85%eb%a1%9c%eb%93%9c aria-label="zip파일 업로드">zip파일 업로드</a></li><li><a href=#lambdaedge-%eb%b0%b0%ed%8f%ac aria-label="Lambda@Edge 배포">Lambda@Edge 배포</a></li></ul></li><li><a href=#%eb%a6%ac%ec%82%ac%ec%9d%b4%ec%a7%95-%ed%85%8c%ec%8a%a4%ed%8a%b8 aria-label="리사이징 테스트">리사이징 테스트</a><ul><li><a href=#%ec%9d%b4%eb%af%b8%ec%a7%80-%eb%a6%ac%ec%82%ac%ec%9d%b4%ec%a7%95 aria-label="이미지 리사이징">이미지 리사이징</a></li><li><a href=#cloudfront-signedurl%ec%9d%84-%ec%82%ac%ec%9a%a9%ed%95%98%eb%8a%94-%ea%b2%bd%ec%9a%b0 aria-label="Cloudfront SignedURL을 사용하는 경우">Cloudfront SignedURL을 사용하는 경우</a></li></ul></li></ul></li><li><a href=#%ec%b0%b8%ea%b3%a0 aria-label=참고>참고</a></li></ul></div></details></div><div class=post-content><p>리사이징 된 이미지를 S3에 저장하지 않고 원본만 이용해서 리사이징 하는 방법은 없을까 고민하던차에 Lambda@Edge를 이용해서 이미지 리사이징 하는 방법을 적용해 보았습니다.</p><h2 id=lambdaedge-동작-원리>Lambda@Edge 동작 원리<a hidden class=anchor aria-hidden=true href=#lambdaedge-동작-원리>#</a></h2><p><figure><a href=/images/2021/0514/lambda-edge.png><img src=/images/2021/0514/lambda-edge.png alt=lambda-edge></a></figure>Lambda@Edge는 CloudFront에 접근할 때 실행되는 Lambda의 확장판입니다.
CloudFront 이벤트가 발생할 때 Lambda 함수를 실행할 수 있습니다.
이벤트는 4가지가 있습니다.</p><ul><li>Viewer Request : CloudFront가 뷰어로부터 요청을 받고 요청한 개체가 edge cache에 있는지 확인하기 전에 함수를 실행합니다.</li><li>Origin Request : CloudFront가 오리진으로 요청을 전달할 때만 실행됩니다. 요청한 개체가 edge cache에 있으면 함수가 실행되지 않습니다.</li><li>Origin Response : CloudFront가 오리진으로부터 응답을 받은 후 응답에 개체를 cache하기 전에 함수를 실행합니다.</li><li>Viewer Response : 요청한 개체를 뷰어에 반환하기 전에 기능이 실행됩니다. 이 함수는 개체가 edge cache에 이미 있는지 여부에 관계없이 실행됩니다.</li></ul><h2 id=lambdaedge-주의점>Lambda@Edge 주의점<a hidden class=anchor aria-hidden=true href=#lambdaedge-주의점>#</a></h2><ul><li>환경변수는 사용 불가</li><li>us-east-1 리전만 대응</li><li>이벤트 유형에 따라 다른 할당량<table><thead><tr><th>Entity</th><th>Origin request and response event quotas</th><th>Viewer request and response event quotas</th></tr></thead><tbody><tr><td>Function memory size</td><td>Same as Lambda quotas（128 MB to 10,240 MB）</td><td>128 MB</td></tr><tr><td>Function timeout</td><td>30 seconds</td><td>5 seconds</td></tr><tr><td>Size of a response</td><td>1 MB</td><td>40 KB</td></tr><tr><td>Maximum compressed size of a Lambda function and any included libraries</td><td>50 MB</td><td>1 MB</td></tr></tbody></table></li></ul><h2 id=이미지-리사이징-구현>이미지 리사이징 구현<a hidden class=anchor aria-hidden=true href=#이미지-리사이징-구현>#</a></h2><h3 id=이미지-리사이징-처리-흐름>이미지 리사이징 처리 흐름<a hidden class=anchor aria-hidden=true href=#이미지-리사이징-처리-흐름>#</a></h3><p>Origin Response이벤트 발생 시, Lambda@Edge함수 실행하는 방법을 이용했습니다.</p><ul><li><a href="https://images.example.com/images/heic_image.heic?w=1500&h=1500">https://images.example.com/images/heic_image.heic?w=1500&h=1500</a> 에 접속</li><li>CloudFront에서 이미지를 요청했지만, cache되어있지 않은 상태.</li><li>CloudFront가 S3오리진에 요청.</li><li>S3오리진에 이미지가 존재하면, S3오리진에서 응답.</li><li>Lambda 함수를 실행하여 이미지 리사이징.</li><li>리사이징 한 이미지를 CloudFront에 캐싱처리 요청.</li><li>CloudFront는 캐싱 후, 브라우저에 리사이징 된 이미지를 표시.</li></ul><h3 id=cloudfront-설정>CloudFront 설정<a hidden class=anchor aria-hidden=true href=#cloudfront-설정>#</a></h3><p>CloudFormation을 이용해서 구축했습니다. DistributionConfig 설정 중 일부를 살펴보겠습니다.
<script type=application/javascript src=https://gist.github.com/bokyung-kang/e1b8475c7b0b08c7e0c9dea8276c712e.js></script></p><h3 id=lambdaedge-iam-role-작성>Lambda@Edge IAM Role 작성<a hidden class=anchor aria-hidden=true href=#lambdaedge-iam-role-작성>#</a></h3><h4 id=policy>Policy<a hidden class=anchor aria-hidden=true href=#policy>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
  <span style=color:#f92672>&#34;Statement&#34;</span>: [
    {
      <span style=color:#f92672>&#34;Sid&#34;</span>: <span style=color:#e6db74>&#34;VisualEditor0&#34;</span>,
      <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
      <span style=color:#f92672>&#34;Action&#34;</span>: [
        <span style=color:#e6db74>&#34;cloudfront:UpdateDistribution&#34;</span>,
        <span style=color:#e6db74>&#34;iam:CreateServiceLinkedRole&#34;</span>,
        <span style=color:#e6db74>&#34;s3:GetObject&#34;</span>,
        <span style=color:#e6db74>&#34;lambda:EnableReplication&#34;</span>,
        <span style=color:#e6db74>&#34;lambda:GetFunction&#34;</span>,
        <span style=color:#e6db74>&#34;logs:CreateLogGroup&#34;</span>,
        <span style=color:#e6db74>&#34;logs:CreateLogStream&#34;</span>,
        <span style=color:#e6db74>&#34;logs:PutLogEvents&#34;</span>
      ],
      <span style=color:#f92672>&#34;Resource&#34;</span>: <span style=color:#e6db74>&#34;*&#34;</span>
    }
  ]
}
</code></pre></div><h4 id=trust-relationship-policy>Trust Relationship Policy<a hidden class=anchor aria-hidden=true href=#trust-relationship-policy>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
  <span style=color:#f92672>&#34;Statement&#34;</span>: [
    {
      <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
      <span style=color:#f92672>&#34;Principal&#34;</span>: {
        <span style=color:#f92672>&#34;Service&#34;</span>: [
          <span style=color:#e6db74>&#34;edgelambda.amazonaws.com&#34;</span>,
          <span style=color:#e6db74>&#34;lambda.amazonaws.com&#34;</span>
        ]
      },
      <span style=color:#f92672>&#34;Action&#34;</span>: <span style=color:#e6db74>&#34;sts:AssumeRole&#34;</span>
    }
  ]
}
</code></pre></div><h3 id=lambda-함수-작성>Lambda 함수 작성<a hidden class=anchor aria-hidden=true href=#lambda-함수-작성>#</a></h3><p>Sharp 리사이징용 패키지 설치 <code>npm install --arch=x64 --platform=linux sharp</code>
<a href=https://sharp.pixelplumbing.com/install#aws-lambda target=_blank rel=noopener>AWS Lambda용 Sharp 설치 가이드</a></p><h4 id=indexjs-작성>index.js 작성<a hidden class=anchor aria-hidden=true href=#indexjs-작성>#</a></h4><script type=application/javascript src=https://gist.github.com/bokyung-kang/a956553c09e6cf737e3caeead15d5a81.js></script><h4 id=zip파일-업로드>zip파일 업로드<a hidden class=anchor aria-hidden=true href=#zip파일-업로드>#</a></h4><p>index.js, node_modules을 zip파일로 압축하고 Code source > Upload from .zip file을 선택해서 파일을 업로드합니다.
Runtime은 Node.js 14.x를 선택합니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>.
├── index.js
├── node_modules/
└── package.json
</code></pre></div><h4 id=lambdaedge-배포>Lambda@Edge 배포<a hidden class=anchor aria-hidden=true href=#lambdaedge-배포>#</a></h4><p>Actions > Deploy to Lambda@Edge를 클릭하고 Lambda@Edge를 배포합니다.<figure><a href=/images/2021/0514/cloudfront_lambda_deploy.png><img src=/images/2021/0514/cloudfront_lambda_deploy.png alt=cloudfront_lambda_deploy></a></figure></p><h3 id=리사이징-테스트>리사이징 테스트<a hidden class=anchor aria-hidden=true href=#리사이징-테스트>#</a></h3><h4 id=이미지-리사이징>이미지 리사이징<a hidden class=anchor aria-hidden=true href=#이미지-리사이징>#</a></h4><p>heic파일을 jpeg로 변경하여 리사이징에 성공한 것을 확인할 수 있습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -I <span style=color:#e6db74>&#39;https://images.example.com/images/heic_image.heic?w=1400&amp;h=1400&#39;</span>
HTTP/2 <span style=color:#ae81ff>200</span>
content-type: image/jpeg
content-length: <span style=color:#ae81ff>356013</span>
date: Fri, <span style=color:#ae81ff>14</span> May <span style=color:#ae81ff>2021</span> 01:50:28 GMT
last-modified: Fri, <span style=color:#ae81ff>14</span> May <span style=color:#ae81ff>2021</span> 01:37:54 GMT
etag: <span style=color:#e6db74>&#34;9835f7aa1198532d0b538axxxxxxxxxx&#34;</span>
accept-ranges: bytes
server: AmazonS3
x-cache: Miss from cloudfront
via: 1.1 186a60433f9963bxxxxxxxxxxxxxx.cloudfront.net <span style=color:#f92672>(</span>CloudFront<span style=color:#f92672>)</span>
x-amz-cf-pop: NRT20-C2
x-amz-cf-id: dihScCemgN8p_VVykjhmXZhkaRP1t7B_y0o_WZoJMK17hexhbHMU0g<span style=color:#f92672>==</span>
</code></pre></div><p>다시 접속하면 cache가 적용된 것을 확인할 수 있습니다.</p><pre><code>curl -I 'https://images.example.com/images/heic_image.heic?w=1400&amp;h=1400'
HTTP/2 200
content-type: image/jpeg
content-length: 356013
date: Fri, 14 May 2021 01:50:28 GMT
last-modified: Fri, 14 May 2021 01:37:54 GMT
etag: &quot;9835f7aa1198532d0b538axxxxxxxxxx&quot;
accept-ranges: bytes
server: AmazonS3
x-cache: Hit from cloudfront
via: 1.1 65866bb6c20ad09xxxxxxxxxxxxxxx.cloudfront.net (CloudFront)
x-amz-cf-pop: NRT57-C2
x-amz-cf-id: C_g2WMkGFgKPtOX87AZBI6J66WDBDARs0pN23DBJSdMam6mUHntFEA==
age: 3
</code></pre><h4 id=cloudfront-signedurl을-사용하는-경우>Cloudfront SignedURL을 사용하는 경우<a hidden class=anchor aria-hidden=true href=#cloudfront-signedurl을-사용하는-경우>#</a></h4><ul><li>SignedURL을 발행합니다.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>aws cloudfront sign <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --url https://images.example.com/images/heic_image.heic?w<span style=color:#f92672>=</span>1400&amp;h<span style=color:#f92672>=</span><span style=color:#ae81ff>1400</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --key-pair-id K2XRXXXXXXXXXX <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --private-key file:///&lt;key path&gt;/private_key.pem <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --date-less-than 2021-05-14T10:50:00+09:00 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --profile &lt;profile name&gt;

https://images.example.com/images/heic_image.heic?w<span style=color:#f92672>=</span>1400&amp;h<span style=color:#f92672>=</span>1400&amp;Expires<span style=color:#f92672>=</span>1620957000&amp;Signature<span style=color:#f92672>=</span>NLDdoaOrD0S8hyEIBzH6Q0otJagaRmUUtX3ZY0uuA0QIzc1e5D6z-ddQ~k0U1~4WQSiK-sDGplt-CPDiUTjz053yFlaDWzQohNybLLVRcUaKRXDgl~ahJPwjfstnKzzOl4g3Z628ZD-8UkLPnPaUx~Ibeo2Z55GFp8Ih0aNBZuPdd0al~4X5~lUGrsgZvRfg0QWis1X3VvShWPLL3nIphAFtJJu0~IfzyKNRZMQMTBvJcqL-ifdA2uj99VHGz-pec7r33y38TW5sirS6kQVJHe9WmAxjDQhTO42M04oSHwu~t6Mrxh3~DalyxEM0wcQ5yWOAKD9FA4~A7im-9tbBTg__&amp;Key-Pair-Id<span style=color:#f92672>=</span>K2XRXXXXXXXXXX
</code></pre></div><ul><li>SignedURL에 접속 해 봅니다. heic파일을 jpeg로 변경하여 리사이징에 성공한 것을 확인할 수 있습니다.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -I <span style=color:#e6db74>&#39;https://images.example.com/images/heic_image.heic?w=1400&amp;h=1400&amp;Expires=1620957000&amp;Signature=NLDdoaOrD0S8hyEIBzH6Q0otJagaRmUUtX3ZY0uuA0QIzc1e5D6z-ddQ~k0U1~4WQSiK-sDGplt-CPDiUTjz053yFlaDWzQohNybLLVRcUaKRXDgl~ahJPwjfstnKzzOl4g3Z628ZD-8UkLPnPaUx~Ibeo2Z55GFp8Ih0aNBZuPdd0al~4X5~lUGrsgZvRfg0QWis1X3VvShWPLL3nIphAFtJJu0~IfzyKNRZMQMTBvJcqL-ifdA2uj99VHGz-pec7r33y38TW5sirS6kQVJHe9WmAxjDQhTO42M04oSHwu~t6Mrxh3~DalyxEM0wcQ5yWOAKD9FA4~A7im-9tbBTg__&amp;Key-Pair-Id=K2XRXXXXXXXXXX&#39;</span>

HTTP/2 <span style=color:#ae81ff>200</span>
content-type: image/jpeg
content-length: <span style=color:#ae81ff>356013</span>
date: Fri, <span style=color:#ae81ff>14</span> May <span style=color:#ae81ff>2021</span> 01:45:27 GMT
last-modified: Fri, <span style=color:#ae81ff>14</span> May <span style=color:#ae81ff>2021</span> 01:37:54 GMT
etag: <span style=color:#e6db74>&#34;9835f7aa1198532d0b538axxxxxxxxxx&#34;</span>
accept-ranges: bytes
server: AmazonS3
x-cache: Miss from cloudfront
via: 1.1 25d5704e1dc4bae769b7dexxxxxxxxxx.cloudfront.net <span style=color:#f92672>(</span>CloudFront<span style=color:#f92672>)</span>
x-amz-cf-pop: NRT57-C2
x-amz-cf-id: 1pJUhQFKbilToyrRCp4_IwkBec1ki3fh5G-Y0fltGoTeRA3WUsymPQ<span style=color:#f92672>==</span>

</code></pre></div><h2 id=참고>참고<a hidden class=anchor aria-hidden=true href=#참고>#</a></h2><ul><li><a href=https://sharp.pixelplumbing.com/install#aws-lambda target=_blank rel=noopener>https://sharp.pixelplumbing.com/install#aws-lambda</a></li><li><a href=https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-requirements-limits.html target=_blank rel=noopener>https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-requirements-limits.html</a></li><li><a href=https://aws.amazon.com/blogs/networking-and-content-delivery/resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog/ target=_blank rel=noopener>https://aws.amazon.com/blogs/networking-and-content-delivery/resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog/</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://bokyung.dev/tags/aws/>AWS</a></li><li><a href=https://bokyung.dev/tags/aws-cloudfront/>AWS CloudFront</a></li><li><a href=https://bokyung.dev/tags/aws-lambdaedge/>AWS Lambda@Edge</a></li><li><a href=https://bokyung.dev/tags/image-resizing/>Image Resizing</a></li><li><a href=https://bokyung.dev/tags/aws-s3/>AWS S3</a></li></ul><nav class=paginav><a class=prev href=https://bokyung.dev/2021/05/17/lambda-sam-deploy/><span class=title>« 이전 페이지</span><br><span>AWS SAM을 이용해서 Lambda함수 배포하기</span></a>
<a class=next href=https://bokyung.dev/2021/04/16/sentry-react/><span class=title>다음 페이지 »</span><br><span>Sentry를 리액트 프로젝트에 적용하기</span></a></nav><div class=ad-box><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8342838924011258 data-ad-slot=2315271952 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></footer><script src=https://utteranc.es/client.js repo=bokyung-kang/blog-comments issue-term=title theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2021 <a href=https://bokyung.dev/>Bokyung's Note</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}</script></body></html>